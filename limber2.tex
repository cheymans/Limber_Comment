\documentclass[fleqn,usenatbib]{mnras} %
\pdfoutput=1

%% Packages
\usepackage{amsmath,amssymb,graphicx}
\usepackage{bm,color}% bold math
%\usepackage{ulem}
\usepackage{mathtools}
\usepackage{url}
\usepackage{footnote}
%\makesavenoteenv{tabular}
\makesavenoteenv{table}

\bibpunct{(}{)}{;}{a}{}{,}

\onecolumn

\pagestyle{empty}
\usepackage{psfrag, epsfig}


\newcommand{\ellbar}{\hbox{\it \l}\,}
\newcommand{\pref}{{\cal A}}
\newcommand{\edth}{\,\eth\,}
\renewcommand{\vec}{\bm}
\renewcommand{\d}[0]{{\rm d}}

\newcommand{\mk}[1]{{\bf\textcolor{blue}{#1}}}


\definecolor{purple}{RGB}{76, 0,153}
\newcommand{\ch}[1]{\textcolor{purple}{\bf #1}}



\title[Precision calculations for cosmic shear]{Precision calculations for cosmic shear}  %??
%{Precision calculations of the cosmic shear power spectrum projection}

\input{authors.tex}

\date{\today}

\pagerange{\pageref{firstpage}--\pageref{lastpage}} \pubyear{2017}

\begin{document}
\setlength{\voffset}{-12mm}

\label{firstpage}


\maketitle
\begin{abstract}

We compute the spherical-sky weak-lensing power spectrum of the shear and
convergence. We discuss various approximations, such as flat-sky, first- and
second-order Limber equations for the projection. We find that the impact of adopting 
these approximations are negligible when constraining cosmological parameters from 
current weak lensing surveys.
This is demonstrated using data from the Canada-France-Hawaii Lensing Survey (CFHTLenS). 
We find that the reported tension with Planck CMB temperature anisotropy results cannot be alleviated, in
contrast to the recent claim made by \citet{2016arXiv161104954K}. 
For future large-scale surveys with unprecedented precision, we show that the spherical
second-order Limber approximation will provide sufficient accuracy, as it is in 
agreement with the full projection at the percent level for $\ell > 3$.  
In the spirit of reproducible research, our numerical implementation of all approximations
and the full projection are publicly available within the package
\textsc{nicaea} at \texttt{http://www.cosmostat.org/software/nicaea}.

\end{abstract}

\begin{keywords}
cosmological parameters -- methods: statistical
\end{keywords}

\input abbr-journals

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
\label{sec:intro}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The measurement of weak gravitational lensing by large-scale structures
provides a powerful cosmological probe of dark matter, dark energy, and
modifications to gravity.  As such it is the primary science goal of several
current (KiDS, DES, HSC\footnote{KiDS: \href={http://kids.strw.leidenuniv.nl}, DES: \href={http://www.darkenergysurvey.org}, HSC: \href={http://hsc.mtk.nao.ac.jp/ssp/}})
and future (Euclid, LSST, WFIRST\footnote{Euclid: \href={http://sci.esa.int/euclid}, LSST: \href={http://www.lsst.org}, WFIRST: \href={http://wfirst.gsfc.nasa.gov}}) surveys.
%(Kilo-Degree Survey, KiDS \citet{kuijken/etal:2015}, Dark Energy Survey, DES, \citet{abbott/etal:2016}, Hyper-Suprime Camera Survey, HSC\footnote{HSC; \href={http://hsc.mtk.nao.ac.jp/ssp/}}) and future (Euclid, \citet{2011arXiv1110.3193L}, LSST, \citet{chang/etal:2013}, WFIRST\footnote{WFIRST; \href={http://wfirst.gsfc.nasa.gov}}) large-scale surveys.
Interest in the results from these surveys is high as statistically significant
deviations have been found between the cosmological parameter constraints from
the CMB Planck experiment \citep{2015arXiv150201589P} in comparison to weak
lensing constraints from both the Kilo-Degree Survey \citep[KiDS;][]{KiDS-450}
and the Canada-France-Hawaii Telescope Lensing Survey
\citep[CFHTLenS;][]{joudaki/etal:2016}.  If the source of this tension is not
a result of so-far unconsidered sources of systematic errors in one or all
experiments, extensions to the standard flat $\Lambda$CDM cosmological models
need to be considered. \citet{joudaki/etal:2017} have shown, for example, that
the tension can be resolved with an evolving dark energy model.

In the era of the upcoming large-scale surveys that will provide measurements of
cosmic shear with unprecedented precision, one needs to revisit the theoretical
predictions of the observables to ensure that the accuracy of the
models meet the accuracy of the upcoming data. In this paper, we examine the widely used Limber
approximation for the projected weak-lensing power spectrum. We consider
spherical coordinates and the flat-sky approximation, and compute the full
projection as well as first- and second-order Limber approximation. We show
that the second-order Limber approximation is an accurate representation of the full projection, with better than percent level precision for scale $\ell > 3$. 
Since this approximation involves only 1D integrals over the matter power spectrum, it is very fast to
calculate numerically and can readily employed in Monte-Carlo sampling methods
to obtain precision constraints on cosmological parameters.

This paper is organised as follows.  In section~\ref{sec:wl} we provide a
pedagogical introduction to weak gravitational lensing theory, projections and
power spectra for the flat-sky and spherical cases, following the seminal work
from \citet{2000PhRvD..62d3007H}, see also \citet{2005PhRvD..72b3516C}. In section~\ref{sec:L2} we
derive weak lensing observables using a second-order limber approximation first
introduced by \citet{2008PhRvD..78l3506L}. We compare the shear power spectrum
and commonly-used two-point shear correlation function for the full solution to
a range of different approximations in section~\ref{sec:comp}, providing
cosmological constraints for each case using CFHTLenS data from
\citet{CFHTLenS-2pt-notomo} in section~\ref{sec:cfhtlens}. This paper draws
from several sources of literature which have previously discussed the full
projection, or reviewed the accuracy of the Limber approximation for weak
lensing studies, namely \citet{2008PhRvD..78d3002S,2012PhRvD..86b3001B,
2012MNRAS.422.2854G, 2016arXiv161104954K}. We present a discussion and
comparison of our results to these papers in Appendix~\ref{app:B}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Weak-lensing projections and power spectra}
\label{sec:wl}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this section we review the basic weak-lensing projection expressions, and
compute lensing power spectra for a spherical case, and in the flat-sky
approximation. For completeness we provide a derivations of the weak lensing power spectra in Appendix~\ref{sec:derivations_C}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The lensing potential}
\label{sec:psi}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


The lensing potential $\psi$ at a direction on the sky $(\theta, \varphi)$ in
the Born approximation is defined as the projected 3D metric potential $\Phi$
along the line of sight \citep{1998ApJ...498...26K,BS01},
%
% Hu00 (21,22) with minus sign
%
\begin{equation}
  \psi(\theta, \varphi) = \frac 2 {{\rm c}^2} \int_0^{\chi_{\rm lim}} \frac{{\rm d}\chi}{\chi}
    \Phi[\chi, f_K(\chi) \theta, f_K(\chi) \varphi; \chi] \, q(\chi),
  \label{eq:psi}
\end{equation}
%
where the lensing efficiency $q$ is given by
%
\begin{equation}
  q(\chi) = \int\limits_\chi^{\chi_{\rm lim}} {\rm d} \chi^\prime \, n(\chi^\prime)
    \frac{f_K(\chi^\prime - \chi)}{f_K(\chi^\prime)},
  %
  \label{eq:lens_efficiency}
\end{equation}
%
corresponding to a population of lensed galaxies with normalised source
redshift distribution $n(z) {\rm d}z = n(\chi) {\rm d} \chi$. Here, ${\rm c}$
is the speed of light, the projection is carried out over comoving distances
$\chi$ up to a limiting distance $\chi_{\rm lim}$, and $f_K(\chi) = |K|^{-1/2}
S_K(|K|^{1/2} \chi)$ is the the comoving angular distance, where the function
$S_K$ equals $\sin$, ${\rm id}$, or $\sinh$ if the spatial curvature of the Universe
$K$ is positive, zero, or negative, respectively.

The form of the lensing efficiency $q$ (\ref{eq:lens_efficiency}) assumes a
homogeneous galaxy distribution without clustering, so that the redshift
distribution in this approximation does not depend on the direction on the sky.
Accounting for this position-dependence leads to correction of weak-lensing
quantities due to clustering of source galaxies with other sources
\citep{2002A&A...389..729S}, and with galaxies associated with lens structures
\citep{1998A&A...338..375B,H02}.

The 3D potential is related to the density contrast $\delta$ via the Poisson
equation. Assuming General Relativity, this relation is written in Fourier space as
%
\begin{align}
  \hat \Phi(\vec k; \chi) = & - \frac 3 2 \Omega_{\rm m} H_0^2 k^{-2} a^{-1}(\chi) \hat \delta(\vec k; \chi),
      \label{eq:poisson}
\end{align}
%
where $\Omega_{\rm m}$ is the matter density parameter, $H_0$ the Hubble constant, $\vec k$ a 3D Fourier wave
vector, and $a$ the scale factor with $a=1$ today.
The Fourier transform of the potential and its inverse are defined as
%
\begin{align}
  \hat \Phi(\vec k; \chi) = &  \int {\rm d}^3 r \, \Phi(\vec r; \chi) {\rm e}^{{\rm i} \vec k \vec r} ;
  \label{eq:hatPhi}
  \\
  \Phi(\vec r; \chi) = &  \int \frac{{\rm d}^3 k}{(2\pi)^3}
      \hat \Phi(\vec k; \chi) {\rm e}^{-{\rm i} \vec r \vec k},
  \label{eq:hatPhi_inv}
\end{align}
%
where the integration range for both integrals is $\mathbb{R}^3$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Lensing power spectra in the spherical case}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Lensing potential power spectrum}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Following \cite{2000PhRvD..62d3007H} we decompose the lensing potential
(\ref{eq:psi}) into a spherical harmonics expansion, in analogy of CMB
temperature, both of which are scalar functions on the sphere. This
decomposition and its inverse are
%
% Hu00 (23)
%
\begin{align}
  \psi(\theta, \varphi) = \sum_{\ell=0}^\infty \sum_{m=-\ell}^\ell \psi_{\ell m} {\rm Y}_{\ell m}(\theta, \varphi);
    \label{eq:psi_harm_exp}
    \\
    %
  \psi_{\ell m} = \int_{\mathbb{S}^2} {\rm d} \Omega \, \psi(\theta, \varphi) {\rm Y}^\ast_{\ell m}(\theta, \varphi).
  \label{eq:psi_harm_exp_inv}
\end{align}
%
To specify tomographic redshift bins $i=0\ldots N_z-1$, we introduce a family
of lensing efficiency functions $q_i$ defined by a corresponding family of
redshift distributions $n_i$ via eq.~(\ref{eq:lens_efficiency}). The resulting
lensing potential is denoted by $\psi_{\ell m, i}$. The tomographic power
spectrum of the lensing potential between two redshift bins $i$ and $j$,
$C_{ij}^\psi$ \citep{pee80} is then defined as
%
\begin{equation}
  \left\langle \psi^{}_{\ell m, i} \, \psi^\ast_{\ell^\prime m^\prime, j} \right\rangle
    = \delta_{\ell \ell^\prime} \delta_{m m^\prime} C^\psi_{ij}(\ell) .
  \label{eq:C_ell_psi}
\end{equation}
%
Using the properties of the spherical harmonics (see
App.~\ref{sec:derivations_C} for details) the power spectrum can be written as
%
\begin{align}
  C_{ij}^\psi(\ell) = & \frac 8 {c^4 \pi} 
  \int_0^{\chi_{\rm lim}} \frac{{\rm d}\chi}{\chi} q_i(\chi)
  \int_0^{\chi^\prime_{\rm lim}} \frac{{\rm d}\chi^\prime}{\chi^\prime} q_j(\chi^\prime)
  \int {\rm d} k k^2 \, {\rm j}_\ell(k \chi) {\rm j}_\ell(k \chi^\prime) P_\Phi(k; \chi, \chi^\prime)
  \label{eq:C_ell_phi_Pphi} \\
  = & \frac 8 \pi \pref^2
  \int_0^{\chi_{\rm lim}} \frac{{\rm d}\chi}{\chi} \frac{q_i(\chi)}{a(\chi)}
  \int_0^{\chi^\prime_{\rm lim}} \frac{{\rm d}\chi^\prime}{\chi^\prime} \frac{q_j(\chi^\prime)}{a(\chi^\prime)}
  \int \frac{{\rm d} k}{k^2} \, {\rm j}_\ell(k \chi) {\rm j}_\ell(k \chi^\prime) P_{\rm m}(k; \chi, \chi^\prime) ;
  \label{eq:C_ell_phi_Pm}
\end{align}
%
where ${\rm j}_\ell$ it the spherical Bessel function of order $\ell$. For
convenience we introduce the normalisation constant $\pref$ as
%
\begin{equation}
  \pref = \frac 3 2 \Omega_{\rm m} \left(\frac{H_0} c\right)^2.
  \label{eq:pref}
\end{equation}
%
The first line expresses $C_{ij}^\psi$ in terms of the 3D potential power spectrum $P_\Phi$, defined as
%
\begin{align}
  \left\langle \hat \Phi(\vec k; \chi) \hat \Phi^\ast(\vec k^\prime; \chi^\prime) \right\rangle
    = & (2\pi)^3 \delta_{\rm D}(\vec k - \vec k^\prime) P_\Phi(k; \chi, \chi^\prime).
    %\nonumber \\
    %= & (2\pi)^3 \delta_{\rm D}(\vec k - \vec k^\prime) \pref^2 k^{-4} a^{-1}(\chi) a^{-1}(\chi^\prime)
      %P_{\rm m}(k; \chi, \chi^\prime).
  \label{eq:p_phi}
\end{align}
%
The second line uses the 3D matter density power spectrum $P_{\rm m}$, which is defined analogously as
%
\begin{align}
  \left\langle \hat \delta(\vec k; \chi) \hat \delta^\ast(\vec k^\prime; \chi^\prime) \right\rangle
    = & (2\pi)^3 \delta_{\rm D}(\vec k - \vec k^\prime) P_{\rm m}(k; \chi, \chi^\prime),
  \label{eq:p_m}
\end{align}
%
and is
related to $P_\Phi$ via the absolute square of the Poisson equation (\ref{eq:poisson}).


In the following section we will discuss the relations between of shear and
convergence to the lensing potential on the sphere, and derive the power
spectrum of the former two fields.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Shear power spectrum}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The shear $\gamma = \gamma_1 + {\rm i} \gamma_2$ is related to the potential at
linear order by the trace-free part of the Jacobi matrix. The involved
differential operator on the sphere is called \emph{edth} derivative, $\edth$,
see \cite{2005PhRvD..72b3516C} for a in-depth mathematical discussion of this
concept. The edth operator $\edth$ ($\edth^\ast$) raises (lowers) the spin $s$
of an object. Twice applying this operator to the scalar (spin-0) potential
creates the spin-2 shear:
%
\begin{align}
  \gamma(\theta, \varphi) = & \frac 1 2 \edth \edth \psi(\theta, \varphi).
    \nonumber \\
  \gamma^\ast(\theta, \varphi) = & \frac 1 2 \edth^\ast \edth^\ast \psi(\theta, \varphi).
  \label{gamma_psi_spher}
\end{align}
%
To write the shear on the sphere in terms of the lensing potential $\psi$, we
insert the harmonics expansion of the potential (\ref{eq:psi_harm_exp}). This
requires to compute second derivatives of the spherical harmonic functions.
This opereration defines a new object, the \emph{spin-weighted spherical
harmonic} $_s{\rm Y}_{\ell m}$. The shear can be written on the sphere in terms
of these functions as a spherical harmonics multipole expansion with
coefficients $_{\pm 2} \gamma_{\ell m}$. This expansion together with its inverse
is
%
% Hu04 (A10), van de Rijt PhD (6.32)
%
\begin{align}
  (\gamma_1 \pm {\rm i} \gamma_2)(\theta, \varphi) = & \sum_{\ell m} \,\, _{\pm 2}\gamma_{\ell m} \; _{\pm 2}\!{\rm Y}_{\ell m}(\theta, \varphi);
  \label{eq:gamma_harm_exp}
    \\
  \, _2 \gamma_{\ell m} = & \int_{\mathbb{S}^2} {\rm d} \Omega \, \gamma(\theta, \varphi) \;  _2\!{\rm Y}^\ast_{\ell m}(\theta, \varphi);
    \nonumber \\
  \, _{-2} \gamma_{\ell m} = & \int_{\mathbb{S}^2} {\rm d} \Omega \, \gamma^\ast(\theta, \varphi) \,  _{-2}\!{\rm Y}^\ast_{\ell m}(\theta, \varphi).
  \label{eq:gamma_harm_exp_inv}
\end{align}
%
The spin-weighted spherical harmonics $_s\!{\rm Y}_{\ell m}$ that are the basis function
in the expansion of the shear (\ref{eq:gamma_harm_exp}) can be calculated via the relations
%
% Rijt (6.16); BBRV12 (9)
%
\begin{align}
  \ellbar(\ell, s) \; _s\!{\rm Y}_{\ell m}(\theta, \varphi) = & \edth^s {\rm Y}_{\ell m}(\theta, \varphi);
    \nonumber \\
  \ellbar(\ell, s) \; _{-s}\!{\rm Y}_{\ell m}(\theta, \varphi) = & (-1)^s \left(\edth^\ast\right)^s {\rm Y}_{\ell m}(\theta, \varphi),
  \label{eq:sYlm_def} 
\end{align}
%
with the spin prefactor \citep{2012PhRvD..86b3001B}
%
\begin{equation}
  \ellbar(\ell, s) = \sqrt{\frac{(\ell + s)!}{(\ell - s)!}}.
  \label{eq:ellbar}
\end{equation} 
%
Inserting the lensing potential expansion (\ref{eq:psi_harm_exp}) into the
expression for the shear (\ref{gamma_psi_spher}), and using (\ref{eq:sYlm_def})
to compute the derivatives, we find for the shear expansion coefficients
\citep{2000PhRvD..62d3007H,2001astro.ph.11605T}
%
% Rijt after (7.5); Taylor01 (18); Hu00 (A10)
%
\begin{equation}
  _{\pm 2} \gamma_{\ell m} = \frac 1 2 \ellbar(\ell, 2) \psi_{\ell m}.
  \label{eq:gamma_ellm_phi_ellm}
\end{equation}
%
The two coefficients $_{+2} \gamma_{\ell m}$ and $_{-2} \gamma_{\ell m}$ are
identical since the potential $\phi$ is a real function.

The tomographic shear power spectrum, in analogy to (\ref{eq:C_ell_phi_Pm}), is defined by
%
\begin{equation}
  \left\langle _2\gamma^{}_{\ell m, i} \; {}_2\gamma^\ast_{\ell^\prime m^\prime, j} \right\rangle
    = \delta_{\ell \ell^\prime} \delta_{m m^\prime} C^\gamma_{ij}(\ell).
  \label{eq:C_ell_gamma}
\end{equation}
%
For a zero-curvature Universe, this is given by
%
\begin{align}
  C^\gamma_{ij}(\ell) = \frac 1 4 \ellbar^2(\ell, 2) \, C^\psi_{ij}(\ell)
                 = & \frac 2 \pi \, \ellbar^2(\ell, 2) \, \pref^2
                 \int_{0}^{\chi_{\rm lim}} \frac{\rm d \chi}{\chi} \frac{q_i(\chi)}{a(\chi)}
                \int_{0}^{\chi_{\rm lim}} \frac{\rm d \chi^\prime}{\chi^\prime}
                \frac{q_j(\chi^\prime)}{a(\chi^\prime)}
                %\nonumber \\
                %& \times
                \int_0^\infty \frac{{\rm d} k}{k^2} \, P_{\rm m}(k, \chi, \chi^\prime) \,
                {\rm j}_\ell(k \chi) \, {\rm j}_\ell(k \chi^\prime) .
  \label{eq:C_ell_full}
\end{align}
%
The spherical prefactor for the full projection power spectrum is $p(\ell) :=
\ellbar^2(\ell, 2)$, which will be modified under flat-sky and Limber
approximations below.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Convergence power spectrum}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The convergence is related to the lensing potential on the sphere via the
product of spin-raising and spin-lowering edth operators, which are identical
to the spherical Laplacian differential operator.

%
\begin{equation}
  \kappa(\theta, \varphi) = \frac 1 2 \edth \edth^\ast \psi(\theta, \varphi) = \frac 1 2 \nabla^2 \psi(\theta, \varphi).
  \label{eq:kappa_psi_spher}
\end{equation}
%
The spherical harmonics are eigenfunctions of the Laplacian,
%
\begin{equation}
  \nabla^2 {\rm Y}_{\ell m}(\theta, \varphi) = - \ell (\ell + 1) {\rm Y}_{\ell m}(\theta, \varphi)
    = - \ellbar^2(\ell, 1) {\rm Y}_{\ell m}(\theta, \varphi),
  \label{eq:nabla_Ylm}
\end{equation}
%
The convergence power spectrum is then similar to the shear power spectrum
(\ref{eq:C_ell_gamma}) with a different spherical prefactor,
%
\begin{equation}
  C^\kappa_{ij}(\ell) = \frac 1 4 \ellbar^4(\ell, 1) \, C^\psi_{ij}(\ell)
    = \frac{\ell (\ell+1)}{(\ell-1)(\ell+2)} C^\gamma_{ij}(\ell) .
  \label{eq:C_ell_kappa_full}
\end{equation}
%
The convergence power spectrum is thus larger than the shear power spectrum, by
10\% for $\ell=4$, 1\% for $\ell = 14$, and less than 0.1\% for $\ell>45$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Flat-sky approximation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Most previous work has used lensing quantities approximated on a flat sky,
neglecting the sky curvature. This is a valid approach for past and current
survey areas that have extents up to 10 degrees or less. The correlation
functions from the observed shear have been calculated using spherical
coordinates, and the effect on large scales is not negligible \citep{FSHK08}.
Here we examine the effect of sky curvature on the theoretical models.

For a flat sky, the spherical harmonics expansions are approximated by Fourier
transforms. The flat-sky equivalent of eqs.~(\ref{eq:psi_harm_exp}) and
(\ref{eq:psi_harm_exp_inv}) are
%
\begin{align}
  \psi(\vec \vartheta) = & \int \frac{{\rm d}^2 \ell}{(2\pi)^2} \, {\rm e}^{-{\rm i} \vec \ell \vec \vartheta} \hat \psi(\vec \ell);
  \label{eq:psi_fourier}
  \\
  %
  \hat \psi(\vec \ell) = & \int {\rm d}^2 \vartheta \, {\rm e}^{{\rm i} \vec \ell \vec \vartheta} \psi(\vec \vartheta);
  \label{eq:psi_fourier_inv}
\end{align}
%
where $\vec \vartheta = (\theta, \varphi)$ is the vector describing a 2D angle on the sky.
Instead of a harmonics coefficients $\psi_{\ell m}$, the Fourier representation of the potential
$\hat \psi$ now depends on the vector $\vec \ell \in R^2$.

The flat-sky power spectrum, the flat-sky analogon of (\ref{eq:C_ell_psi}) is defined by
%
\begin{equation}
  \left\langle \hat \psi_i^{}(\vec \ell) \hat \psi_j^\ast(\vec \ell^\prime) \right\rangle
    = (2\pi)^2 \delta_{\rm D}(\vec \ell - \vec \ell^\prime) P^\psi_{ij}(\ell).
  \label{eq:P_ell_psi}
\end{equation}
%
\cite{2000PhRvD..62d3007H} have shown that for small angles the harmonics
expansion (\ref{eq:psi_harm_exp}) can be approximated by the the Fourier
representation (\ref{eq:psi_fourier}). They also demonstrated that the power
spectra are approximately equal, $P^\psi \approx C^\psi$.

For a spin-2 field, \cite{2000PhRvD..62d3007H} approximates the edth operator by Cartesian derivatives, and approximates
(\ref{eq:sYlm_def}) as
%
\begin{equation}
  \ell^2 \, _{\pm2}\!{\rm Y}_{\ell m}(\theta, \varphi) =  {\rm e}^{{\mp}2 {\rm i} \phi_\ell}
    (\partial_1 \pm \partial_2)^2 \, {\rm Y}_{\ell m}(\theta, \varphi).
  \label{eq:sYlm_def_flat}
\end{equation}
%
The spin prefactor $\sqrt{(\ell-1) \ell (\ell+1) (\ell+2)}$ is replaced by $\ell^2$ in flat coordiates.
We find for the flat-sky shear power spectrum
%
\begin{align}
  P^\gamma_{ij}(\ell) 
                 = & \frac 2 \pi \, \ell^4 \, \pref^2
                 \int_{0}^{\chi_{\rm lim}} \frac{\rm d \chi}{\chi} \frac{q_i(\chi)}{a(\chi)}
                \int_{0}^{\chi_{\rm lim}} \frac{\rm d \chi^\prime}{\chi^\prime}
                \frac{q_j(\chi^\prime)}{a(\chi^\prime)}
                %\nonumber \\
                %& \times
                \int_0^\infty \frac{{\rm d} k}{k^2} \, P_{\rm m}(k, \chi, \chi^\prime) \,
                {\rm j}_\ell(k \chi) \, {\rm j}_\ell(k \chi^\prime) .
  \label{eq:P_ell_gamma_full_der}
\end{align}
%
with flat-sky prefactor $p(\ell) = \ell^4$.
\mk{See App.~\ref{sec:schmidt08} and \ref{sec:giannantonio12} for discussions of alternative expressions of the flat-sky power spectrum.}


\section{Second-order Limber approximation for weak lensing}
\label{sec:L2}

\subsection{Spherical case}

We follow \cite{2008PhRvD..78l3506L} who derive the second-order Limber
expansion for general projections from 3D to 2D scalar fields in the spherical,
all-sky case. First, we use the identity of Bessel functions
%
\begin{equation}
  {\rm j}_\ell(x) = \sqrt{\frac{\pi}{2x}} {\rm J}_{\ell + 1/2}(x)
\end{equation}
%
in eq.~(\ref{eq:C_ell_full}), where ${\rm J}_\ell$ is the first-kind Bessel
function of order $\ell$. Next, \cite{2008PhRvD..78l3506L} solve integrals of
the form
%
\begin{equation}
  \int_0^\infty {\rm d} \chi f(\chi) {\rm J}_{\ell + 1/2}(k \chi)
  = \int_0^\infty {\rm d} x k^{-1} f(x/k) {\rm J}_{\ell + 1/2}(x)
  \label{eq:int_dchi}
\end{equation}
%
by performing a Taylor expansion of the function $f$ around $x = k \chi = \nu$, where
the Bessel function has its approximate maximum.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Geometric mean cross-correlation power spectrum}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To separate the $k$- and $\chi, \chi^\prime$-terms in (\ref{eq:C_ell_full}), we
first approximate the matter power cross-spectrum between two distances as
geometric mean of the two involved distances \cite{2005PhRvD..72b3516C,2016arXiv161200770K},
%
\begin{equation}
 P_{\rm m}(k; \chi, \chi^\prime) = \sqrt{ P_{\rm m}(k; \chi) P_{\rm m}(k; \chi^\prime) }
  \label{eq:P_geom_mean}
\end{equation}
%
With this, eq.~(\ref{eq:C_ell_full}) is written as
%
\begin{align}
  C^\gamma_{ij}(\ell) \approx & \, \ellbar^2(\ell, 2) \, \pref^2
                \int_0^\infty \frac{{\rm d} k}{k^3} \,
                % P_{\rm m}(k) \,
                \int_{0}^\infty \frac{{\rm d} \chi}{\chi^{3/2}} \sqrt{P_{\rm m}(k; \chi)}
                \frac{q_i(\chi)}{a(\chi)} {\rm J}_{\ell+1/2}(k \chi)
                \nonumber \\
                 & \times
                \int_{0}^\infty \frac{{\rm d} \chi^\prime}{{\chi^\prime}^{3/2}}
                \sqrt{P_{\rm m}(k; \chi^\prime)} \frac{q_j(\chi^\prime)}{a(\chi^\prime)} {\rm J}_{\ell+1/2}(k \chi^\prime)
  \label{eq:C_ell_full_Pk}
\end{align}
%
We replaced the upper limits of the distance integral with infinity. \mk{Comment on this.}
Note that this equation has a preactor $\ellbar^2(\ell, 2)$ corresponding to a spin-2 field, in contrast
to \cite{2008PhRvD..78l3506L} who show calculations for a scalar field.

Following \cite{2008PhRvD..78l3506L} we expand to third order
%
\begin{equation}
  \lim_{\varepsilon \rightarrow 0} \int_0^\infty {\rm d} x \, {\rm e}^{-\epsilon (x - \nu)} g(x) {\rm J}_\nu(x)
  %\approx g(\nu) - \frac 1 2 g^{\prime\prime}(\nu) - \frac \nu 6 g^{\prime\prime\prime}(\nu) 
  \approx g(\nu) - \frac 1 2 \left.\frac{{\rm d}^2 g}{{\rm d} x^2}\right|_{x=\nu}
                 - \frac \nu 6 \left.\frac{{\rm d}^3 g}{{\rm d} x^3}\right|_{x=\nu} ,
\end{equation}
%
with $g(x) = k^{-1} f(k, \chi)$, $\chi=x/k$, and its derivatives $g^{(n)}(x) =
k^{-1-n} f^{(n)}(k, \chi)$ for a given $k$. In our case the projection kernel is
%
\begin{equation}
  f(k, \chi) = \sqrt{P_{\rm m}(k; \chi)} \, a^{-1}(\chi) \chi^{-3/2} q(\chi).
  \label{eq:f_LA08}
\end{equation}
%
(Add indices $i, j$ to $f$ and $q$ for the tomographic case.)
%
Replacing both distance integrals in (\ref{eq:C_ell_full_Pk}) by their Taylor-expansions around $\nu = k \chi$ and $\nu = k \chi^\prime$,
respectively, yields
%
\begin{align}
  C^\gamma_{ij}(\ell) \approx & \, \ellbar^2(\ell, 2) \, \pref^2
    \int_0^\infty \frac{{\rm d} k}{k^3} \, k^{-2}
    \left[ f_i(k, \chi) - \frac{1}{2 k^2} f_i^{\prime\prime}(k, \chi)
      - \frac{\nu}{6 k^3} f_i^{\prime\prime\prime}(k, \chi) + \ldots \right]
    %\nonumber \\
    %& \times
    \left[ f_j(k, \chi) - \frac{1}{2 k^2} f_j^{\prime\prime}(k, \chi)
    - \frac{\nu}{6 k^3} f_j^{\prime\prime\prime}(k, \chi) + \ldots \right]
  \label{eq:C_ell_limber2_dk}
\end{align}
%
Changing the integration to $\chi = \nu/k$ and collecting terms according to their $\nu$-dependence:
%
\begin{align}
  C^\gamma_{ij}(\ell) \approx & \, C^\gamma_{{\rm L1}, ij}(\ell) + C^\gamma_{{\rm L2}, ij}(\ell)
      \nonumber \\
    = & \frac{\ellbar^2(\ell, 2)}{\nu^4} \, \pref^2
    \int_0^\infty {\rm d} \chi \, \chi^3 \, % P_{\rm m}\left( k \right)
    %\Bigg\{
    \left\{
    (f_i f_j)(\nu/\chi, \chi)
    %\right.
      %\nonumber \\
    %&
    %\left.
     - \frac 1 {\nu^2} \left[ \frac{\chi^2}{2} \left( f^{}_i f^{\prime\prime}_j + f_i^{\prime\prime} f^{}_j \right)(\nu/\chi, \chi)
    + \frac{\chi^3}{6} \left( f^{}_i f^{\prime\prime\prime}_j + f^{\prime\prime\prime}_i f^{}_j \right)(\nu/\chi, \chi)
    \right]
    \right\}
    %\Bigg\}
  \label{eq:C_ell_limber12_dr}
\end{align}
%
The first term corresponds to the well-known first-order Limber approximation
\cite{1953ApJ...117..134L,1992ApJ...388..272K}, which is very widely used in
weak gravitational lensing. We retrieve the (spherical) standard expression by
inserting back the projection kernel (\ref{eq:f_LA08}) and the time-dependent
power spectrum,
%
\begin{align}
  C^\gamma_{{\rm L1}, ij}(\ell) = & \, \frac{\ellbar^2(\ell, 2)}{\nu^4} \, \pref^2 \int {\rm d} \chi \frac{ q_i(\chi) q_j(\chi) }{a^2(\chi)}
  P_{\rm m}\left(\frac{\nu}{\chi}; \chi\right).
  \label{eq:C_ell_limber1}
\end{align}
%
In the Limber approximation, modes between structures at different epochs do
not contribute to the single line-of-sight integration.

The second-order Limber term in (\ref{eq:C_ell_limber12_dr}) has an additional
$\nu^{-2}$-dependence, and is therefore strongly suppressed for large $\ell$.
%
\begin{align}
  C^\gamma_{{\rm L2}, ij}(\ell) = & - \frac 1 {\nu^2} \, \frac{\ellbar^2(\ell, 2)}{\nu^4} \, \pref^2
    \int {\rm d} \chi \, \chi^{2} a^{-2} \sqrt{P_{\rm m}\left(\frac\nu\chi; \chi\right)}
    %\nonumber \\
    %& \times
    \frac{a(\chi)}{2} \chi^{3/2} \left[ q^{}_i f^{\prime\prime}_j + f^{\prime\prime}_i q^{}_j
      + \frac{\chi}{3} \left( q^{}_i f^{\prime\prime\prime}_j + f^{\prime\prime\prime}_i q^{}_j
      \right)
    \right](\nu/\chi, \chi)
  \label{eq:C_ell_limber2_dr} 
\end{align}
%
The higher-order derivatives of the filter functions have to be computed
numerically in the general case. These suffer from numerical noise and are
sensitive to the set-up, for example the step size. The tabulation and
interpolation of those derivatives is time-taking since they depend on two
arguments, $\nu$ and $\chi$. In the following section, we will separate the
$k$- and $\chi$-dependend parts of the power spectrum to make the numerical
derivatives faster and more smooth.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Time-independent power spectrum separation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To further develop (\ref{eq:P_geom_mean}), we divide out the growth factor to
define a redshift-independent power spectrum $P_{\rm m}(k)$,
%
\begin{equation}
 P_{\rm m}(k, \chi) =: D_+(\chi) P_{\rm m}(k).
  \label{eq:P_k_chi_sep_s}
\end{equation}
%
This is not exact, since some non-linear prescriptions of the power spectrum
depend on redshift other than the growth factor, for example when computing the
non-linear scale $k_{\rm NL}(z)$ for \texttt{halofit}.

With this approximation, the $k$-independent term factors out from
(\ref{eq:f_LA08}), and we define the separated kernel function $f_{\rm s}$ as
%
\begin{equation}
  f_{\rm s}(\chi) = D_+(\chi) a^{-1}(\chi) \chi^{-3/2} q(\chi).
  \label{eq:f_LA08_s}
\end{equation}
%
and does not need to be considered when taking the derivatives with respect to comoving distances.
The second-order Limber term of the shear power spectrum can then be simplified to
%
\begin{align}
  C^\gamma_{{\rm L2}, ij}(\ell) = & - \frac 1 {\nu^2} \, \frac{\ellbar^2(\ell, 2)}{\nu^4} \, \pref^2
    \int {\rm d} \chi \, \chi^{2} a^{-2} P_{\rm m}\left(\frac\nu\chi; \chi\right)
    %\nonumber \\
    %& \times
    \frac {a(\chi)}{2 D_+(\chi)} \chi^{3/2}
    \left[ q^{}_i f^{\prime\prime}_{{\rm s} j} + f^{\prime\prime}_{{\rm s}i} q^{}_j
      + \frac{\chi}{3} \left( q^{}_i f^{\prime\prime\prime}_{{\rm s}j} + f^{\prime\prime\prime}_{{\rm s}i} q^{}_j
      \right)
    \right](\chi)
  \label{eq:C_ell_limber2_dr_s}
\end{align}
%
We compute the numerical higher derivatives as follows. The functions $f_{\rm
s}(\chi)$ are fitted as power laws with index $\approx 1.5$. The fit is
performed between $\chi_{\rm min} = 0.001 {\rm Mpc}/h$ and $\chi_{\rm max} =
500 \mbox{Mpc}/h$. At larger comoving distances the kernel decreases faster
than a power law, so we exclude this range from the fit. Even though the
derivaties are larger due to the steeper decline, the associated errors are
very small since those scales are down-weighed by the kernel function $f_{\rm
s}$ itself. At $\chi = 500 \mbox{Mpc}/h$ the filter function is less than
$10^{-4}$ of its value of unity at Mpc$/h$.

%The error between filter and power-law fit
%becomes larger than $50\%$ only for scales larger than $1,500 \mbox{Mpc}/h$. On the angular
%scales where the second-order Limber approximation significantly contributes to the shear
%power spectrum, $\ell \le 100$, this corresponds to $k < 0.03 h/$Mpc, linear
%scales where the 3D power spectrum is small and does not strongly contribute to the lensing
%power spectrum.

\subsection{Flat sky}
\label{sec:Limber_flat_sky}

The extended flat-sky Limber approximation is readily derived from the
spherical case, by replacing the prefactor $\ellbar^2(\ell, 2)$ with $\ell^4$,
%
\begin{align}
  P^\gamma_{{\rm L1}, ij}(\ell) = & \, \frac{\ell^4}{\nu^4} \, \pref^2 \int {\rm d} \chi \frac{ q_i(\chi) q_j(\chi) }{a^2(\chi)}
  P_{\rm m}\left(k = \frac{\nu}{\chi}; \chi\right);
  \label{eq:P_ell_limber1}
  \\
    P^\gamma_{{\rm L2}, ij}(\ell) = & - \frac 1 {\nu^2} \, \frac{\ell^4}{\nu^4} \, \pref^2
    \int {\rm d} \chi \, \chi^{2} a^{-2} P_{\rm m}\left(k = \frac\nu\chi; \chi\right)
    %\nonumber \\
    %& \times
    \frac{a(\chi)}{2 D^{-1}_+(\chi)} \chi^{3/2} \left[ q^{}_i f^{\prime\prime}_{{\rm s}j} + f^{\prime\prime}_{{\rm s}i} q^{}_j  
      + \frac{\chi}{3} \left( q^{}_i f^{\prime\prime\prime}_{{\rm s}j} + f^{\prime\prime\prime}_{{\rm s}i} q^{}_j
      \right)
    \right](\chi)
  \label{eq:P_ell_limber2}
\end{align}
%
Different further approximations are commonly made for the prefactor $p(\ell) = \ell^4/\nu^4$ and $\nu(\ell)$:
%
\begin{enumerate}
  \item $p(\ell) = 1$, this corresponds to $\nu(\ell) = \ell$, which is the \emph{standard} Limber approximation.
    Until recently, i.e.~for all pre-2014 CFHTlenS results, this was the approximation of choice.
  \item $p(\ell) = \ell^4/(\ell + 1/2)^4$. This corresponds to the \emph{extended} Limber
    approximation with $\nu(\ell) = \ell + 1/2$; however the following case is typically employed:
  \item $p(\ell) = 1$, but as the argument of the 3D power spectrum $\nu = \ell + 1/2$. This is
    a \emph{hybrid} between
    standard and extended Limber approximation, and was used in \cite{KiDS-450,joudaki/etal:2016}. As is shown
    later, this is a much better approximation to the full projection than case (ii).
\end{enumerate}

% (i)  Standard Flat
% (ii) Extended Flat
% (iii) Extended Flat Hybrid

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}
\label{sec:results}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Comparison of the approximations for the lensing power spectrum}
\label{sec:comp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


In Fig.~\ref{fig:Cl_cases} we plot the full spherical projection of the shear power spectrum in comparison to shear power spectra derived assuming
the range of different approximations listed in Table~\ref{tab:cases}.  The adopted redshift distribution corresponds to CFHTLenS
\cite{CFHTLenS-2pt-notomo} and we assume their best-fit flat $\Lambda$CDM cosmology with $\Omega_{\rm m}=0.279$, $\Omega_{\rm b}=0.046$, $\sigma_8=0.79$, $H_0=0.701$, $n_{\rm s}=0.96$. 
For $\ell > 100$ we find that all shear power spectra predictions agree with the full spherical solution to better than one percent, with the majority of the approximations tested accurate to better than 0.1 per cent.   

Considering first the flat-sky cases, the standard first-order Limber approximation, (L1Fl), that was adopted for all pre-2014 CFHTLenS analyses, we find to be 
accurate to better than 10\% for $\ell>3$, converging slowly to the true projection with percent level precison at $\ell>100$. 
For the extended Limber approximations `hybrid' cases (ExtL1FlHyb and ExtL2FlHyb), despite decreased accuracy
for $\ell < 8$ in comparison to the standard first-order Limber case, the errors with respect to
the true power spectrum decrease much faster, as $\ell^{-2}$, such that percent-level precision is reached at $\ell>15$.  The first-order extended Limber approximation `hybrid' cases (ExtL1FlHyb) was adopted by both \citet{joudaki/etal:2016} and \cite{KiDS-450}\footnote{We confirm that there is a typographical error in equation 4 of \cite{KiDS-450} which should include the extra term of `+0.5' in $\nu(\ell)$ that was incorporated in the cosmological analysis.}. 

The outlier in the flat-sky cases is the extended Limber approximation (ExtL1Fl) which performs relatively poorly, and
reaches 10\% precision only at $\ell > 100$. The same slow convergence can be
observed for the corresponding second-order flat case, ExtL2Fl. To our knowledge this form of the flat-sky approximation has not been used in any cosmic shear studies to date, and should not be used in any future studies given these results.  The poor behaviour of this case, in comparison with the `hybrid' case, (e.g ExtL1FlHyb) can be understood by considering Taylor expansions of the different pre-factors.  The spherical pre-factor,
\begin{equation}
p(\ell) = \frac{(\ell+2)(\ell+1)\ell(\ell-1)}{(\ell + 0.5)^4} = 1-{5\over 2\ell^2} +{\cal O}(\ell^{-3}) \, .
\end{equation}
can be compared to the flat-sky extended Limber pre-factor
\begin{equation}
p(\ell) = \ell^4 / (\ell + 0.5)^4 = 1-{2\over \ell}+{5\over 2\ell^2} +{\cal O}(\ell^{-3}) \, , 
\end{equation} 
showing it to be more deviant from the full spherical solution, than the `hybrid' $p(\ell) = 1$ case. 

Considering now the spherical-sky cases, we find that including the spherical pre-factor decreases the difference between the extended Limber approximated cases (ExtL1Sph and ExtL2Sph) and the full spherical solution by a factor of a few for $\ell < 5$.   We find that using the spherical-sky second-order extended Limber approximation (ExtL2Sph) yields percent accuracy down to $\ell > 3$.  The numerical calculation of the second-order extended Limber approximation is a factor of \ch{X} faster than the calculation of the full spherical solution.   We note that the noise seen in the right panel of Fig.~\ref{fig:Cl_cases} is due to numerical noise arising from numerical integration errors the full spherical solution calculation for
$\ell > 20$.  Increasing numerical precision would increase the calculation time still further, relative to the  second-order extended Limber calculation.


\begin{figure}

  \begin{center}
    \resizebox{1.0\hsize}{!}{
      \includegraphics{figures/P_kappa_limber_comp}
      \includegraphics{figures/P_kappa_limber_delta}
    }
  \end{center}

  \caption{Shear power spectrum for different approximation. Limber to first order: standard with flat-sky (L1Fl),
        extended for flat sky (ExtL1Fl), extended hybrid for flat sky (ExtL1FlHyb),
        and extended in the spherical expansion (ExtL1Sph);
        second-order Limber approximations: extended flat sky (ExtL2Fl), extended hybrid flat sky (ExtL2FlHyb),
        and extended spherical expansion (ExtL2Sph); full (exact) spherical projection (FullSph).
        The left panels show the total power spectrum.
        See Table \ref{tab:cases} for more details on the different approximations.     
        }

  \label{fig:Cl_cases}

\end{figure}


% nicaea            Kil+17      'Comment paper' Plot color    Kit+16                Plot color    my comment
% limber            L1Fl        Kst             black         Limber+Tl=1+Flat-sky  blue
% limber_la08       ExtL1Fl     ELF             blue
% limber_la08_hyb   ExtL1FlHyb  ESt             magenta                                           prefactor~1 despite nu=ell+1/2
% limber_la08_sph   ExtL1Sph    ELS             cyan
% limber2_la08      ExtL2Fl
% limber2_la08_hyb  ExtL2FlHyb
% limber2_la08_sph  ExtL2Sph
% full              Full

\renewcommand{\baselinestretch}{1.5}
\begin{table}
\begin{centering}
  \label{tab:cases}
  \caption{Shear power spectrum approximations compared in this paper. 'ID' is the abbrevation used in the plots.
    The third column shows the power-spectrum prefactor $p(\ell)$. }  
    \begin{tabular}{|l|l|c|c|c}
  \hline
  Case & ID & eq.~ & prefactor & $\nu(\ell)$ \\ \hline
  % 
  $1^{\rm st}$-order standard Limber, flat sky & L1Fl & (\ref{eq:P_ell_limber1}) + (i)
    & $1$ & $\ell$ \\ \hline
  %
  $1^{\rm st}$-order extended Limber, flat sky & ExtL1Fl & (\ref{eq:P_ell_limber1}) + (ii)
    & $\ell^4/(\ell+1/2)^4$ & $\ell + 1/2$ \\ \hline
  %
  $1^{\rm st}$-order extended Limber, hybrid, flat sky & ExtL1FlHyb & (\ref{eq:P_ell_limber1}) + (iii)
    & $1$ & $\ell + 1/2$ \\ \hline
  %
  $1^{\rm st}$-order extended Limber, spherical & ExtL1Sph & (\ref{eq:C_ell_limber1})
    & $\ellbar^2(\ell, 2)/(\ell+1/2)^4$ & $\ell+1/2$ \\ \hline
  %
  $2^{\rm st}$-order extended Limber, flat sky & ExtL2Fl &  (\ref{eq:P_ell_limber1}) + (\ref{eq:P_ell_limber2}) + (iii)
    & $\ell^4/(\ell+1/2)^4$ 
    & $\ell+1/2$ \\ \hline
  %
  $2^{\rm st}$-order extended Limber, hybrid, flat sky & ExtL2FlHyb &  (\ref{eq:P_ell_limber1}) + (\ref{eq:P_ell_limber2}) + (iii)
    & $1$ 
    & $\ell+1/2$ \\ \hline
  %
  $2^{\rm st}$-order extended Limber, spherical & ExtL2Sph & (\ref{eq:C_ell_limber1})+(\ref{eq:C_ell_limber2_dr_s})
    & $\ellbar^2(\ell, 2)/(\ell+1/2)^4$ & $\ell+1/2$ \\ \hline
  %
  Full spherical & FullSph & (\ref{eq:C_ell_full}) &
      $\ellbar^2(\ell, 2)$ & - \\ \hline
  %
  \end{tabular}

\end{centering}
\end{table}
\renewcommand{\baselinestretch}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Effects on the shear correlation function}
\label{sec:comp_xi}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



Most cosmic shear analysis to date have been performed on real-space
correlation statistics, since these can be measured direcaly from an observed
galaxy shape catalogue. The basic quantity is the two-point correlation
function \citep{1991ApJ...370....1M}, which is given by
%
\begin{align}
  \xi_+(\theta) 
  % &
  = \frac 1 {2\pi} \int {\rm d} \ell \, \ell {\rm J}_0(\ell
   \theta)
  P^\gamma(\ell);
  \quad
  %\nonumber \\
   %
   \xi_-(\theta)
  %&
  = \frac 1 {2\pi} \int
   {\rm d} \ell \, \ell {\rm J}_4(\ell \theta)
  P^\gamma(\ell).
  %
   \label{eqn:xiGG}
\end{align}
%
where ${\rm J}_\nu$ first-kind Bessel function of order $\nu$. The flat-sky
shear power spectrum $P^\gamma$ an be related to the underlying matter power
spectrum through equation \ref{eq:P_ell_limber1} when adopting a first-order
extended Limber approximation, or equation~\ref{eq:P_ell_limber2} when adopting
a second-order extended Limber approximation \citep[for more details see][and
references therein]{1991ApJ...370....1M,1992ApJ...388..272K,
BS01}.

On a sphere, correlation functions cannot be related to the power spectrum by a
Hankel transform in equation~\ref{eqn:xiGG}, as the spherical power spectrum is
formally not defined for non-integer $\ell$ \citep[see][for alternative
spherical-sky formulae for the two-point correlation
function]{2005PhRvD..72b3516C}. In particular, the spherical Bessel functions
necessary to compute the full projection (\ref{eq:C_ell_full}) is defined only
for integer order $\ell$. \mk{Is this really true?}

However, in the Limber approximations the Bessel functions expanded to by
polynomials, allowing for arbitrary wave modes $\ell$. The spherical prefactor
$\ellbar(\ell, 2)$ (\ref{eq:ellbar}) can be generalised to non-integer
arguments and is positive for $\ell \le 2$. We can thus use the spherical power
spectrum in the Limber approximations for the Hankel transformation to compute
the two-point correlation functions, This is not entirely consistent, but
serves the purpose of comparison to the flat-sky case.

In addition, as we have shown in section~\ref{sec:comp} that the spherical
second-order extended Limber approximation provides a percent-level precision
representation of the full spherical projection for $\ell > 3$, we do not
present predictions for the two-point shear correlation function using the full
spherical projection, instead choosing the spherical second-order extended
Limber approximation (Ext2Sph) as our \mk{reference} in this case.

Figure.~\ref{fig:xi_pm} presents the two-point correlation functions
$\xi_+$ (left) and $\xi_-$ (right) using the different cases for the shear
power spectrum listed in Table~\ref{tab:cases}. The adopted CFHTLenS redshift
distribution and fiducial cosmological model are the same as in
Figure.~\ref{fig:Cl_cases}. As is clear by the red dotted curve, using the
Planck cosmology \citep{2015arXiv150201589P} induces a much larger change in
the amplitude of the shear correlation function than the different projection
methods.


\begin{figure}

  \begin{center}
    \resizebox{1.0\hsize}{!}{
      \includegraphics{figures/xi_p_comp}
      \includegraphics{figures/xi_m_comp}
    }

    \resizebox{1.0\hsize}{!}{
      \includegraphics{figures/xi_p_delta}
      \includegraphics{figures/xi_m_delta}
    }
  \end{center}

  \caption{Shear correlation functions $\xi_+$ (\emph{left}) and $\xi_-$ (\emph{right}).
    The lower panels shows the relative differences to the case ExtL2Sph,  see Table \ref{tab:cases} for the different
    approximations and their symbols.
    The theoretical model corresponds to the CFHTLenS best-fit parameters with
    $\Omega_{\rm m} = 0.279$, $h=0.701$, and $\sigma_8 = 0.79$ \citep{CFHTLenS-2pt-notomo},
    except the red dashed curve with adapts a Planck-best fit
    cosmology with $\Omega_{\rm m} = 0.3$, $h=0.67$ and $\sigma_8 = 0.83$ \citep{2015arXiv150201589P}.
  }

  \label{fig:xi_pm}

\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Application to CFHTLenS data}
\label{sec:cfhtlens}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\input{cfhtlens.tex}

\input{discussion.tex}

\section{Conclusions}
\input{conclusions.tex}

\section*{Acknowledgments}

The authors thank Tommaso Giannantonio, Sarah Bridle, Ami Choi, Donnacha Kirk, Lance Miller, Benjamin Joachimi, Chris Blake and Adam Amara for very helpful discussions.
This work was financially supported by the DFG (Emmy Noether grants Hi 1495/2-1 and SI 1769/1-1; TR33 `The Dark Universe'), the Alexander von Humboldt Foundation, the ERC (grants 279396, 647112), the Seventh Framework Programme of the European Commission (Marie Sklodwoska Curie Fellowship grant 656869), NSERC and CIfAR.

\ch{Check your acknowledgements}

\bibliographystyle{mnras}
\bibliography{astro}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{appendix}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Derivation of the weak-lensing power spectra}
\label{sec:derivations_C}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The following derivations are detailed e.g.~in \cite{2000PhRvD..62d3007H} and
\cite{2005PhRvD..72b3516C}.

\subsection{Spherical case}

\subsubsection{Lensing potential power spectrum}

To obtain the power spectrum of the lensing potential for a flat Universe, 
we insert the lensing projection (\ref{eq:psi}) for $K=0$ into the
inverse harmonics expansion (\ref{eq:psi_harm_exp_inv}) and write the 3D potential
as its Fourier transform (\ref{eq:hatPhi_inv}) to get
%
\begin{equation}
  \psi_{\ell m} = \frac 2 {c^2} \int {\rm d} \Omega {\rm Y}^\ast_{\ell m}(\theta, \varphi)
    \int_0^{\chi_{\rm lim}} \frac{{\rm d}\chi}{\chi} q(\chi) \int \frac{{\rm d}^3 k}{(2\pi)^3} \hat \Phi(\vec k; \chi) {\rm e}^{-{\rm i} \vec k \vec r}.
\end{equation}
%
The 3D position vector $\vec r$ is a 3D position vector with polar coordinate
$r = \chi$ and polar angles $(\theta, \varphi)$. Similarly we denote with
$\theta_k, \varphi_k$ the polar angles of the 3D Fourier vector $\vec k$. We
insert the expansion of a plane wave into spherical harmonics,
%
% BBRV12 (41)
%
\begin{equation}
  {\rm e}^{{\rm i} \vec k \vec r} = 4 \pi \sum_{\ell=0}^{\infty} \sum_{m=-\ell}^{\ell}
    {\rm i}^\ell \, {\rm j}_\ell(k \chi)
    {\rm Y}_{\ell m}(\theta, \varphi) {\rm Y}_{\ell m}(\theta_k, \varphi_k) .
  \label{eq:wave_exp}
\end{equation}
%

Making use of the orthogonality of the spherical harmonics
%
% Rijt (6.15), Castro (B2).
%
\begin{equation}
  \int {\rm d} \Omega {\rm Y}^{}_{\ell m}(\theta, \varphi) {\rm Y}^\ast_{\ell^\prime m^\prime}(\theta, \varphi) = \delta_{\ell \ell^\prime} \delta_{m m^\prime},
  \label{eq:Yellm_ortho}
\end{equation}
%
the expression for $\psi_{\ell m}$ simplifies to
%
\begin{equation}
  \psi_{\ell m} = \frac {{\rm i}^\ell}{c^2 \pi^2} \int_0^{\chi_{\rm lim}} \frac{{\rm d}\chi}{\chi} q(\chi) \int {\rm d}^3 k \,
    \hat \Phi(\vec k; \chi) {\rm j}_\ell(k \chi) {\rm Y}_{\ell m}(\theta_k, \varphi_k).
  \label{eq:psi_ellm}
\end{equation}
%
We take the absolute square and use the definition of the 3D potential power spectrum (\ref{eq:p_phi}),
to arrive at expression (\ref{eq:C_ell_phi_Pphi}).

$P_{\rm m}$ is the 3D matter power cross-spectrum at line-of-sight comoving
Fourier mode $k$ and comoving distances $\chi$ and $\chi^\prime$. We denote
complex conjugation with superscript $^\ast$.
\mk{Peter's comment: What does the correlation between two epochs actually mean if they
are not on the backward light cone?}

The delta-function resolves one 3D Fourier
integral. We split the second integration into radial and spherical
coordinates, ${\rm d}^3 k = {\rm d} k k^2 {\rm d} \Omega_k$ and use once again
the orthogonality of the spherical harmonics to resolve the spherical integral. 
This leads to the potential power spectrum (\ref{eq:C_ell_phi_Pm}).




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Discussion and comparison to previously published work}
\label{app:B}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this section we briefly discuss previously published work on the full
projection and second-order Limber equation of the lensing power spectrum. We
compare those results with our findings.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Kitching et al.~2016}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\cite{2016arXiv161104954K} compute the full projection of the weak-lensing
power spectrum, which they present as spherical-radial representation the 3D
shear field. Our results (\ref{eq:C_ell_full}) correspond to their equations
(7) and (8) for a flat Universe and in the case of perfect photometric
redshifts, $p(z | z_{\rm p}) = \delta_{\rm D}(z - z_{\rm p})$, and for a bin
function that selects the redshift bin $i$, $W^{\rm SR}(z, z_{\rm p}) = 1_{z
\in i-\mbox{th bin}}$. In \cite{2016arXiv161104954K} eq.~(7) the factor $2/\pi$
is absent.

In App.~A \cite{2016arXiv161104954K} derives the spherical and extended Limber
approximation starting from the full spherical projection. Note that their
filter function $q$ defined in (31) has an errornous additional factor of
comoving distance $r$, and shows an additional factor of $\pi/2$.

As shown in the main text of our paper,
we can not reproduce the amplitude of the differences between the cases,
neither for the power spectrum nor for the shear correlation function (see
Figs.~\ref{fig:Cl_cases} and \ref{fig:xi_pm}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Bernardeau, Bonvin, Van de Rijt, Vernizzi (2012); van de Rijt (2012)}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Eq.~(44) of \cite{2012PhRvD..86b3001B} is the non-tomographic full projection
$C(\ell)$ in the approximation of the 3D potential power spectrum $P^\Phi$ separating
into $k$- and $\chi$-dependent functions. Their expression holds for a single
source redshift.

The PhD thesis of Van de Rijt \cite{vande2012} presents an explicit calculation
of the second-order Limber approximation. They carry out the derivatives of the
kernels $f$ under the assumption of a constant growth-suppression factor
$D_+(a)/a$. Then, for a constant source comoving distance $\chi_{\rm S}$, the
lensing efficiency (\ref{eq:lens_efficiency}) is $q(\chi) = (\chi_{\rm S} -
\chi) \chi_{\rm S}^{-1}$, and the derivative of the separated kernel function
(\ref{eq:f_LA08_s}) can be calculated analytically,
%
\begin{equation}
  f^{\prime\prime}(\chi) + \frac{\chi}{3} f^{\prime\prime\prime}(\chi)
    = - \frac 1 8 \chi^{-5/2} \left( \frac 5 \chi
          + \frac 1 {\chi_{\rm S}} \right) \frac{D_+(\chi)}{a(\chi)}.
\end{equation}
%
This result confirms the power-law behaviour of the filter function, which we exploited earlier to fit
this function.

Inserting this into the second-order Limber power spectrum
(\ref{eq:C_ell_limber2_dr_s}) and using the inverse Poisson equation to replace
the matter with the potential power spectrum we obtain the same expression as
\cite{vande2012} (their eq.~7.19), except for an additional factor $a^2(\chi)$.
This difference is accounted for by the factor $a^{-1}$ in the propagation of
primordial potential perturbations to late times, see eq.~(6.22) in
\cite{vande2012}, where the transition is done using $g(a)$ instead of $D(a)$.
\mk{Check this further.}

In Fig.~\ref{fig:L1L2E_Rijt} we reproduce Fig.~7.3 from \cite{vande2012} using
a similar set up (flat $\Lambda$ Universe with $\Omega_{\rm m} = 0.3, h=0.65,
\Omega_{\rm b} = 0.0461, \sigma_8 = 0.8, n_{\rm s} = 0.96$. All source galaxies
are at redshift $z_{\rm S} = 1$. The non-linear 3D matter power spectrum from
\cite{2012ApJ...761..152T} is used. The ratio of the first-and second- Limber
approximated power spectra to the full projection shows excellent agreement at
the sub-percent level.

\begin{figure}

  \begin{center}
    \resizebox{0.5\hsize}{!}{
      \includegraphics{figures/P_kappa_limber_delta_Rijt}
    }
  \end{center}

    \caption{Relative differences in percentage of spherical first- and second-order Limber
    shear power spectra with respect to the full projection
    as function of wave mode $\ell$, see Table \ref{tab:cases}. The redshift distribution
    is a single source plane at $z_{\rm S}=1$, and the cosmological parameters (see text) are chosen to match
    \citet{vande2012}, see their Fig.~7.3 for comparison.
    }

    \label{fig:L1L2E_Rijt}

\end{figure}



\subsection{LoVerde \& Afshordi (2009)}

This paper introduces the extended Limber approximation to second order that we
apply in this work. Although they present the specific case of 2D galaxy
clustering, their calculations are general enough to apply to a weak-lensing
context. Their eq.~(5) is a spherical cross-power spectrum of two scalar fields
$A$ and $B$, projected from 3D to 2D via projection kernels $F_A$ and $F_B$
defined in their eq.~(4). Comparing their expressions with the weak-lensing
potential (\ref{eq:psi}), we set $F_A(\chi) = F_B(\chi) = 2 c^{-2}
D_+(\chi) q(\chi) \chi^{-1}$. With that, their eq.~(5) is identical to our
(\ref{eq:C_ell_phi_Pphi}).

The second-order Limber approximation in \cite{2008PhRvD..78l3506L} is
presented in eq.~(12). This is consistent with our first-order
(\ref{eq:C_ell_limber1}) and second-order (\ref{eq:C_ell_limber2_dr}) Limber
approximation terms, when accounting for the difference between lensing
potential and shear 2D power spectrum, and 3D potential and matter power
spectrum.


\subsection{Schmidt (2009)}
\label{sec:schmidt08}

In eq.~(9) \cite{2008PhRvD..78d3002S} write the lensing power spectrum in the
flat-sky limit. Inserting the Poisson factor $D_\phi$, 
 the growth function $D_{\rm m}$, and writing the redshift filter
function $W_\kappa$ (eq.~10) in terms of the lensing efficiency and comoving distances,
$W_\kappa[z(\chi)] = H(z)^{-1} \chi q(\chi)$, their expression, using our notations, reads
%
\begin{align}
  P_{ij}^\gamma(\ell) = & \frac 2 \pi \, \pref^2
                 \int_{0}^{\chi_{\rm lim}} {\rm d} \chi \chi \, \frac{q_i(\chi)}{a(\chi)}
                \int_{0}^{\chi_{\rm lim}} {\rm d} \chi^\prime\, \chi^\prime
                \frac{q_j(\chi^\prime)}{a(\chi^\prime)}
                \nonumber \\
                & \times \int_0^\infty {\rm d} k \, k^2 \, P_{\rm m}(k; \chi, \chi^\prime) \,
                {\rm j}_\ell(k \chi) \, {\rm j}_\ell(k \chi^\prime) ,
  \label{eq:P_ell_gamma}
\end{align}
%
This is consistent with our equation (\ref{eq:P_ell_gamma_full_der}) under the additional assumption that
mainly modes with $k \chi \approx k \chi^\prime \approx \ell$ contribute to the integral; that is modes
around the maxima of the Bessel functions. Then, we can draw out of the integral the factor $\ell^4 \approx k^4 \chi^2 {\chi^\prime}^2$,
to recover (\ref{eq:P_ell_gamma_full_der}).
\mk{This argument is very hand-wavey! In fact, using the approximation $k \chi = \ell$ seems to go too far, this is already halfway the Limber approximation.}

%\begin{align}
  %W_\kappa(z) = & \frac 1 {H(z)} \int_z^\infty {\rm d} z_{\rm s} W_{\rm L}(z_{\rm s}, z) W_{\rm g}(z)
              %=  \frac 1 {H(z)} \chi \int_\chi^\infty {\rm d} \chi^\prime \frac{\chi^\prime - \chi}{\chi^\prime}
                %n(\chi)
              %\nonumber \\
              %& \equiv \frac 1 {H(z)} \chi q(\chi),
%\end{align}
%%
%using ${\rm d} z W_{\rm g}(z) = {\rm d} \chi n(\chi)$.
%To write the redshift integrals (9) in \cite{2008PhRvD..78d3002S} over 
%comoving distance, we make the variable transformation
%%
%\begin{equation}
  %{\rm d} \chi = \frac{c {\rm d} z}{H(z)} .
%\end{equation}
%%
%We

\subsection{Giannantonio et al. (2012)}
\label{sec:giannantonio12}

In eqs.~(25) and (26) \cite{2012MNRAS.422.2854G} write the flat-sky lensing
power spectrum. Their window function $W^{\varepsilon_i}$ defined in (25) for a
flat Universe equals $\pref \times q(\chi) / a(\chi)$, since ${\rm d} z \,
({\rm d} N(z)/{\rm d} z) = {\rm d} \chi n(\chi)$; however due to a typo there
is a factor $r_K[r(z)]$ missing in the window function, which translates into a
missing $r_K[r] r_K[r^\prime]$ in the full projection integral\footnote{Typo
confirmed by T.~G., priv.~comm.}. This also leads to an errorous $r_K^{-2}(r)$
in the Limber equation (27). With these factors accounted for, and making the
additional approximation $k \chi \approx k \chi^\prime \ell$ (see
App.~\ref{sec:schmidt08}) we reproduce the expressions of
\cite{2012MNRAS.422.2854G}.


\label{lastpage}

\end{appendix}

\end{document}

